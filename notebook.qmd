---
title: "Ozonesonde profiles from the South Pole"
format: html
editor_options: 
  chunk_output_type: inline
---

## Quarto

```{r}
library(tidyverse)

targets::tar_load(processed_data)
targets::tar_load(images)
```

```{r}
processed_data %>%
  expand(date) %>%
  group_by(year(date)) %>%
  count()
```

How frequent are the flights over the course of the year? Could use this information to determine x-resoution of grid.

```{r}
processed_data %>%
  expand(date) %>%
  ggplot()+
  geom_bar(aes(x=year(date)))+
  facet_wrap(~month(date))
  
```

Could as few as two flights per month, or as many as 10.

More flights in the months of September-October which is the austral Spring when the ozone hole first starts forming, and before satellites are able to measure it (due to darkness in polar region). Especially critical to make these measurements via sondes at this time.

Steps for making the figure:

1)  Define the grid that will be used to depict the contour plot

-   I will choose to plot values based on interval of 10 days since that would complement the less active months better
-   I will plot at altitudes every 1 km between 12 - 24 km which is the region which experiences the majority of ozone depletion during the formation of the hole.
-   I will facet the plots by year, a la NOAA GML OZWV.

2)  Prepare training data

-   First I will prepare the training set from the sonde data, masking the data based on the altitudes and years required above.

3)  Fit model

-   Next I will fit a KNN regression model to the training set using default hyperparameters
-   Then I will use it to make predictions for the grid established above.

```{r}

plotter <- function(df){
  ggplot(df) +
  geom_tile(aes(x=jdate, y = alt, fill= ozone_ppmv))+
  facet_wrap(~year)
}

images %>%
  nest(data = -id) %>%
  mutate(plots = map(data, ~plotter(.x))) %>%
  pull(plots)


```
