---
title: "Ozonesonde profiles from the South Pole"
format: html
editor_options: 
  chunk_output_type: inline
---

## Quarto

```{r message=FALSE}
library(tidyverse)

targets::tar_load(images)
```

Steps for making the figure:

1)  Define the grid that will be used to depict the contour plot

-   I will choose to plot values based on interval of 10 days since that would complement the less active months better
-   I will plot at altitudes every 1 km between 12 - 24 km which is the region which experiences the majority of ozone depletion during the formation of the hole.
-   I will facet the plots by year, a la NOAA GML OZWV.

2)  Prepare training data

-   First I will prepare the training set from the sonde data, masking the data based on the altitudes and years required above.

3)  Fit model

-   Next I will fit a KNN regression model to the training set using default hyperparameters
-   Then I will use it to make predictions for the grid established above.

```{r results="hide"}

plotter <- function(df, id){
  
  title <- paste("Neighbors:", str_extract(id, "(?<=_)\\d+"))
  ggplot(df) +
    geom_tile(aes(x=jdate, y = alt, fill = ozone_ppmv))+
    ggtitle(title)+
    facet_wrap(~year)
}

images %>%
  nest(data = -id) %>%
  mutate(plots = map2(data, id, ~plotter(.x, .y))) %>%
  pull(plots)


```
